pipeline {
    agent any

    parameters {
        string(name: 'GIT_REPO', defaultValue: 'git@github.com:sonalisnehi108/test-nodeapp-1-task.git', description: 'Git repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to build')
        string(name: 'AWS_REGION', defaultValue: 'us-east-1', description: 'AWS region')
        string(name: 'ECR_REPO', defaultValue: '486753526071.dkr.ecr.us-east-1.amazonaws.com/node-app-repo', description: 'ECR repository URI')
        string(name: 'APP_HOST', defaultValue: 'ec2-18-213-218-65.compute-1.amazonaws.com', description: 'App host IP or DNS')
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: "${params.BRANCH}",
                    url: "${params.GIT_REPO}",
                    credentialsId: 'github-ssh'
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    def image = docker.build("node-app:latest")

                    sh """
                        aws ecr get-login-password --region ${params.AWS_REGION} | \
                        docker login --username AWS --password-stdin ${params.ECR_REPO}
                        docker tag node-app:latest ${params.ECR_REPO}:latest
                        docker push ${params.ECR_REPO}:latest
                    """
                }
            }
        }

        stage('Deploy to App Host') {
            steps {
                sshagent(['app-host-ssh']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ubuntu@${params.APP_HOST} '
                            aws ecr get-login-password --region ${params.AWS_REGION} | \
                            docker login --username AWS --password-stdin ${params.ECR_REPO}

                            if [ \$(docker ps -q --filter "name=node-app") ]; then
                                docker stop node-app
                                docker rm node-app
                            fi

                            docker pull ${params.ECR_REPO}:latest
                            docker run -d --name node-app -p 3000:3000 ${params.ECR_REPO}:latest
                        '
                    """
                }
            }
        }

        }
    }
